import uuid
from sqlalchemy import Column, String, Integer, ForeignKey, Enum, DateTime
from sqlalchemy.orm import relationship
from sqlalchemy.dialects.postgresql import UUID

from app.database.db import Base

class Communication(Base):
  __tablename__ = 'communications'
  id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
  level = Column(Enum("info", "warn", "fatal", name="communication_levels"))
  value = Column(String, nullable=False)
  
  scan_id = Column(UUID(as_uuid=True), ForeignKey('scans.id'))
  scan = relationship("Scan", back_populates="messages")

class ConfigurationOption(Base):
  __tablename__ = 'configuration_options'
  id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
  name = Column(String, nullable=False)
  value = Column(String, nullable=True)
  source = Column(Enum("argument", "file", "env_variable", "other", name="config_sources"), nullable=True)

  scan_id = Column(UUID(as_uuid=True), ForeignKey('scans.id'))
  scan = relationship("Scan", back_populates="options")

class Vendor(Base):
  __tablename__ = 'vendors'
  id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
  name = Column(String, nullable=False)

  analyzers = relationship("Analyzer", back_populates="vendor")
  scanners = relationship("Scanner", back_populates="vendor")
  cvss_vectors = relationship("CVSSVector", back_populates="vendor")

class Analyzer(Base):
  __tablename__ = 'analyzers'
  id = Column(String, primary_key=True)
  name = Column(String, nullable=False)
  version = Column(String, nullable=False)
  vendor_id = Column(UUID(as_uuid=True), ForeignKey('vendors.id'))
  url = Column(String, nullable=True)

  vendor = relationship("Vendor", back_populates="analyzers")
  scans = relationship("Scan", back_populates="analyzer")

class Scanner(Base):
  __tablename__ = 'scanners'
  id = Column(String, primary_key=True)
  name = Column(String, nullable=False)
  version = Column(String, nullable=False)
  vendor_id = Column(UUID(as_uuid=True), ForeignKey('vendors.id'))
  url = Column(String, nullable=True)

  vendor = relationship("Vendor", back_populates="scanners")
  scans = relationship("Scan", back_populates="scanner")

class Identifier(Base):
  __tablename__ = 'identifiers'
  id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
  type = Column(String, nullable=False)
  name = Column(String, nullable=False)
  value = Column(String, nullable=False)
  url = Column(String, nullable=True)

class CVSSVector(Base):
  __tablename__ = 'cvss_vectors'
  id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
  vector = Column(String, nullable=False)
  vendor_id = Column(UUID(as_uuid=True), ForeignKey('vendors.id'))

  vendor = relationship("Vendor", back_populates="cvss_vectors")

class Link(Base):
  __tablename__ = 'links'
  id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
  url = Column(String, nullable=False)
  name = Column(String, nullable=True)

class Location(Base):
  __tablename__ = 'locations'
  id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
  file = Column(String, nullable=True)
  start_line = Column(Integer, nullable=True)
  end_line = Column(Integer, nullable=True)
  class_name = Column(String, nullable=True) 
  method_name = Column(String, nullable=True)
  vulnerability_id = Column(UUID(as_uuid=True), ForeignKey('vulnerabilities.id'))

  vulnerabilities = relationship("Vulnerability", back_populates="location")

class Flag(Base):
  __tablename__ = 'flags'
  id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
  type = Column(Enum("flagged-as-likely-false-positive", name="flag_types"))
  origin = Column(String, nullable=False)
  description = Column(String, nullable=False)

class Vulnerability(Base):
  __tablename__ = 'vulnerabilities'
  id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
  name = Column(String, nullable=True)
  description = Column(String, nullable=False, default='')
  severity = Column(Enum("Info", "Unknown", "Low", "Medium", "High", "Critical", name="severity_levels"), nullable=True)
  solution = Column(String, nullable=True)
  raw_source_code_extract = Column(String, nullable=True)

  location_id = Column(UUID(as_uuid=True), ForeignKey('locations.id'))
  location = relationship("Location", back_populates="vulnerabilities")
  
  identifiers = relationship("Identifier")  # Assuming identifiers are not modeled for deletion cascade or updating.
  cvss_vectors = relationship("CVSSVector")
  links = relationship("Link")
  flags = relationship("Flag")

class Scan(Base):
  __tablename__ = 'scans'
  id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
  analyzer_id = Column(UUID(as_uuid=True), ForeignKey('analyzers.id'))
  start_time = Column(DateTime, nullable=False)
  end_time = Column(DateTime, nullable=False)
  scanner_id = Column(UUID(as_uuid=True), ForeignKey('scanners.id'))
  status = Column(Enum("success", "failure", name="scan_statuses"), nullable=False)
  scan_type = Column(Enum("sast", name="scan_types"), nullable=False)

  analyzer = relationship("Analyzer", back_populates="scans")
  scanner = relationship("Scanner", back_populates="scans")
  messages = relationship("Communication", back_populates="scan")
  options = relationship("ConfigurationOption", back_populates="scan")

class Remediation(Base):
  __tablename__ = 'remediations'
  id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
  summary = Column(String, nullable=False)
  diff = Column(String, nullable=False)

  fixes = relationship("VulnerabilityIdentifier", back_populates="remediation")

class VulnerabilityIdentifier(Base):
  __tablename__ = 'vulnerability_identifiers'
  id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
  vulnerability_id = Column(UUID(as_uuid=True), ForeignKey('vulnerabilities.id'))

  remediation_id = Column(UUID(as_uuid=True), ForeignKey('remediations.id'))
  remediation = relationship("Remediation", back_populates="fixes")

class SecurityReport(Base):
  __tablename__ = 'security_reports'
  id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
  version = Column(String, default="15.0.7")
  scan_id = Column(UUID(as_uuid=True), ForeignKey('scans.id'))
  report_schema = Column(String, default="https://gitlab.com/gitlab-org/security-products/security-report-schemas/-/blob/master/dist/sast-report-format.json")

  scan = relationship("Scan")
  vulnerabilities = relationship("Vulnerability")
  remediations = relationship("Remediation")

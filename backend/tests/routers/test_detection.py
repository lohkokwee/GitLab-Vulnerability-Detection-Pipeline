from faker import Faker
from random import randint
from fastapi.testclient import TestClient
from sqlalchemy.orm import Session
from starlette.status import HTTP_202_ACCEPTED

from app.config.app import settings
from app.routers.detection import DETECTION_API_PREFIX

def test_start(client: TestClient) -> None:
  test_endpoint = f"{settings.API_VERSION_PREFIX}{DETECTION_API_PREFIX}/start"
  fake = Faker()
  data = {
    "gl_project_dir": f"{fake.file_path()}",
    "gl_commit_sha": f"{fake.sha1()}",
    "gl_project_id": f"{fake.random_number(digits=5)}",
    "gl_pipeline_id": f"{fake.random_number(digits=5)}",
    "gl_job_id": f"{fake.random_number(digits=5)}",
    "diff": [f'{fake.file_path()}' for i in range(randint(1, 10))]
  }
  print(test_endpoint)
  print(data)
  reponse = client.post(
    test_endpoint,
    json=data
  )
  print(reponse.json())
  assert reponse.status_code == HTTP_202_ACCEPTED
  content = reponse.json()
  assert "id" in content
  assert content["gl_project_dir"] == data["gl_project_dir"]
  assert content["gl_commit_sha"] == data["gl_commit_sha"]
  assert content["gl_project_id"] == data["gl_project_id"]
  assert content["gl_pipeline_id"] == data["gl_pipeline_id"]
  assert content["gl_job_id"] == data["gl_job_id"]
  assert content["diff"] == data["diff"]
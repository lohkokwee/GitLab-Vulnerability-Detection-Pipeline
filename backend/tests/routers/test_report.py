from fastapi.testclient import TestClient
from starlette.status import HTTP_200_OK

from app.config.app import settings

from app.routers.report import REPORT_API_PREFIX
from tests.factories.detection import JobFactory
from tests.factories.report import SecurityReportFactory

def test_get_report(client: TestClient) -> None:
  job = JobFactory()
  security_report = SecurityReportFactory(job=job)
  test_endpoint = f"{settings.API_VERSION_PREFIX}{REPORT_API_PREFIX}/get_by_gl_job_id/{job.gl_job_id}"
  response = client.get(
    test_endpoint
  )
  content = response.json()
  assert response.status_code == HTTP_200_OK
  assert not "id" in content
  assert content["version"] == "15.0.7"
  assert "scan" in content
  assert "analyzer" in content["scan"] 
  assert "scanner" in content["scan"] 
  assert "vulnerabilities" in content
  assert len(content["vulnerabilities"]) == 5
  assert "remediations" in content
  assert len(content["remediations"]) == 5